version: '3.8'

x-versions:
  mcp-gateway-socket-proxy-version: &mcp-gateway-socket-proxy-version wollomatic/socket-proxy:1.11.0
  mcp-gateway-version: &mcp-gateway-version docker/mcp-gateway:latest
  homeassistant-mcp-version: &homeassistant-mcp-version voska/hass-mcp:latest
  ha-file-server-version: &ha-file-server-version renehagen/ha-mcp-file-server:latest
  docker-mcp-version: &docker-mcp-version acuvity/mcp-server-docker:1.0.1
  ssh-mcp-version: &ssh-mcp-version bvisible/mcp-ssh-manager:latest
  spiderfoot-version: &spiderfoot-version spiderfoot/spiderfoot:4.0
  misp-version: &misp-version coolacid/misp-docker:v2.4.186

# Global logging policy to prevent disk bloat
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  mcp-gateway-socket-proxy:
    image: *mcp-gateway-socket-proxy-version
    container_name: mcp-gateway-socket-proxy
    ipc: private
    restart: unless-stopped
    read_only: true
    mem_limit: 64M
    cap_drop: [ALL]
    security_opt: [no-new-privileges]
    user: "65534:${DOCKER_SOCKET_GID}"
    command:
      - '-loglevel=info'
      - '-allowfrom=mcp-gateway,docker-mcp'
      - '-listenip=0.0.0.0'
      - '-allowGET=/(containers/.*|images/.*|events|info|version)'
      - '-allowHEAD=/_ping'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - mcp-gateway
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 sh -c 'cat < /dev/null > /dev/tcp/127.0.0.1/2375' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/wollomatic/socket-proxy/releases/tag/$${major}.$${minor}.$${patch}"
      wud.display.name: "MCP Socket Proxy"

  mcp-gateway:
    image: *mcp-gateway-version
    container_name: mcp-gateway
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 512M
    ports: ["8080:8080"]
    environment:
      TZ: "${TZ}"
      DOCKER_HOST: "tcp://mcp-gateway-socket-proxy:2375"
    volumes:
      - /opt/docker/mcp-gateway/mcp-gateway/config:/app/config:ro
      - /opt/docker/mcp-gateway/mcp-gateway/certs:/certs:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      mcp-gateway-socket-proxy: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.display.name: "MCP Gateway"

  homeassistant-mcp:
    image: *homeassistant-mcp-version
    container_name: homeassistant-mcp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 256M
    environment:
      TZ: "${TZ}"
      HA_URL: "http://10.10.1.11:8123"
      HA_TOKEN: "${HA_MCP_TOKEN}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep python | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.display.name: "HA MCP Server"

  ha-file-server:
    image: *ha-file-server-version
    container_name: ha-file-server
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 256M
    environment:
      TZ: "${TZ}"
      HA_URL: "http://10.10.1.11:8123"
      HA_TOKEN: "${HA_FILE_TOKEN}"
      BASE_PATH: "/config/esphome"
    volumes:
      - /opt/docker/mcp-gateway/ha-file-server:/data
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep python | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  docker-mcp:
    image: *docker-mcp-version
    container_name: docker-mcp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 128M
    environment:
      TZ: "${TZ}"
      DOCKER_HOST: "tcp://mcp-gateway-socket-proxy:2375"
    depends_on:
      mcp-gateway-socket-proxy: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/acuvity/mcp-server-docker/releases/tag/v$${major}.$${minor}.$${patch}"

  ssh-mcp:
    image: *ssh-mcp-version
    container_name: ssh-mcp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 128M
    volumes:
      - /opt/docker/mcp-gateway/ssh-mcp:/root/.ssh:ro
      - /etc/localtime:/etc/localtime:ro
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  spiderfoot:
    image: *spiderfoot-version
    container_name: spiderfoot
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    mem_limit: 2G  # Spiderfoot is heavy on scans
    ports: ["5001:5001"]
    volumes:
      - /opt/docker/mcp-gateway/spiderfoot:/var/lib/spiderfoot
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+$$'
      wud.link.template: "https://github.com/smicallef/spiderfoot/releases/tag/v$${major}.$${minor}"

  misp:
    image: *misp-version
    container_name: misp
    ipc: private
    restart: unless-stopped
    mem_limit: 2G # MISP requires significant RAM
    ports: ["8081:80"]
    volumes:
      - /opt/docker/mcp-gateway/misp:/var/www/MISP
      - /etc/localtime:/etc/localtime:ro
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^v\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/MISP/MISP/releases/tag/v$${major}.$${minor}.$${patch}"

networks:
  mcp-gateway:
    name: mcp-gateway
    driver: bridge