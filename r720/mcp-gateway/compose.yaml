version: '3.8'

x-versions:
  mcp-gateway-socket-proxy-version: &mcp-gateway-socket-proxy-version wollomatic/socket-proxy:1.11.0
  mcp-gateway-version: &mcp-gateway-version docker/mcp-gateway:latest
  homeassistant-mcp-version: &homeassistant-mcp-version voska/hass-mcp:latest
  ha-file-server-version: &ha-file-server-version node:22-bookworm-slim
  docker-mcp-version: &docker-mcp-version acuvity/mcp-server-docker:1.0.1
  spiderfoot-version: &spiderfoot-version josaorg/spiderfoot:latest
  misp-version: &misp-version misp/misp-docker:latest
  misp-mariadb-version: &misp-mariadb-version mariadb:10.11

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  mcp-gateway-socket-proxy:
    image: *mcp-gateway-socket-proxy-version
    container_name: mcp-gateway-socket-proxy
    ipc: private
    restart: unless-stopped
    read_only: true
    mem_limit: 64M
    cap_drop: [ALL]
    security_opt: [no-new-privileges]
    user: "65534:${DOCKER_SOCKET_GID}"
    command:
      - '-loglevel=info'
      - '-allowfrom=mcp-gateway,docker-mcp'
      - '-listenip=0.0.0.0'
      - '-allowGET=/(containers/.*|images/.*|events|info|version)'
      - '-allowHEAD=/_ping'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [mcp-gateway]
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 sh -c 'cat < /dev/null > /dev/tcp/127.0.0.1/2375' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging: *default-logging
    labels:
      wud.watch: "true"

  mcp-gateway:
    image: *mcp-gateway-version
    container_name: mcp-gateway
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 512M
    ports: ["8080:8080"]
    environment:
      TZ: "${TZ}"
      DOCKER_HOST: "tcp://mcp-gateway-socket-proxy:2375"
    volumes:
      - /opt/docker/mcp-gateway/mcp-gateway/config:/app/config:ro
      - /opt/docker/mcp-gateway/mcp-gateway/certs:/certs:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      mcp-gateway-socket-proxy: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  homeassistant-mcp:
    image: *homeassistant-mcp-version
    container_name: homeassistant-mcp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 256M
    environment:
      TZ: "${TZ}"
      HA_URL: "http://10.10.1.11:8123"
      HA_TOKEN: "${HA_MCP_TOKEN}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep python | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  ha-file-server:
    image: *ha-file-server-version
    container_name: ha-file-server
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 256M
    environment:
      TZ: "${TZ}"
      HA_URL: "http://10.10.1.11:8123"
      HA_TOKEN: "${HA_FILE_TOKEN}"
      HA_CONFIG_PATH: "/config"
    command: sh -c "npx -y @renehagen/ha-mcp-file-server"
    volumes:
      - /opt/docker/mcp-gateway/ha-file-server/config:/config:ro
      - /etc/localtime:/etc/localtime:ro
    networks: [mcp-gateway]
    logging: *default-logging

  docker-mcp:
    image: *docker-mcp-version
    container_name: docker-mcp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 128M
    environment:
      TZ: "${TZ}"
      DOCKER_HOST: "tcp://mcp-gateway-socket-proxy:2375"
    depends_on:
      mcp-gateway-socket-proxy: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  spiderfoot:
    image: *spiderfoot-version
    container_name: spiderfoot
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 2G
    ports: ["5001:5001"]
    volumes:
      - /opt/docker/mcp-gateway/spiderfoot:/var/lib/spiderfoot
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  misp:
    image: *misp-version
    container_name: misp
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    cap_add: [CHOWN, SETGID, SETUID, DAC_OVERRIDE]
    user: "root" 
    mem_limit: 2G
    ports: ["8081:80"]
    environment:
      - PUID=${DOCKER_PUID}
      - PGID=${DOCKER_PGID}
      - MISP_BASEURL=http://localhost:8081
      - MYSQL_HOST=misp-mariadb
      - MYSQL_LOGIN=misp
      - MYSQL_PASSWORD=${MISP_DB_PASSWORD}
      - MYSQL_DATABASE=misp
    volumes:
      - /opt/docker/mcp-gateway/misp:/var/www/MISP
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      misp-mariadb: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"

  misp-mariadb:
    image: *misp-mariadb-version
    container_name: misp-mariadb
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    cap_add: [CHOWN, DAC_OVERRIDE, FOWNER, SETGID, SETUID]
    user: "root"
    mem_limit: 1G
    environment:
      - MYSQL_ROOT_PASSWORD=${MISP_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=misp
      - MYSQL_USER=misp
      - MYSQL_PASSWORD=${MISP_DB_PASSWORD}
    volumes:
      - /opt/docker/mcp-gateway/misp-mariadb:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [mcp-gateway]
    logging: *default-logging

networks:
  mcp-gateway:
    name: mcp-gateway
    driver: bridge