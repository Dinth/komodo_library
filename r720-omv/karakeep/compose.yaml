services:
  karakeep:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - MKNOD
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    container_name: karakeep
    environment:
      NEXTAUTH_SECRET: "${KARAKEEP_SECRET}"
      MEILI_MASTER_KEY: "${MEILISEARCH_SECRET}"
      TZ: "${TZ}"
      NEXTAUTH_URL: "https://keep.${DOMAIN_NAME}"
      DATA_DIR: "/data"
      MEILI_ADDR: http://karakeep-meilisearch:7700
      BROWSER_WEB_URL: http://karakeep-chrome:9222
      OLLAMA_BASE_URL: "http://10.10.1.13:11434"
      INFERENCE_TEXT_MODEL: "qwen2.5:14b"
      INFERENCE_IMAGE_MODEL: "llava:13b"
    labels:
      traefik.enable: "true"
      traefik.http.routers.karakeep.rule: "Host(`keep.${DOMAIN_NAME}`)"
      traefik.http.routers.karakeep.entrypoints: "websecure"
      traefik.http.routers.karakeep.tls: "true"
      traefik.http.routers.karakeep.tls.certresolver: "letsencrypt"
      traefik.http.routers.karakeep.tls.domains[0].main: "${DOMAIN_NAME}"
      traefik.http.routers.karakeep.tls.domains[0].sans: "*.${DOMAIN_NAME}"
      traefik.http.routers.karakeep.middlewares: "secHeaders@file"
      traefik.http.services.karakeep.loadbalancer.server.port: "3000"
      homepage.group: "Home"
      homepage.name: "KaraKeep"
      homepage.icon: "sh-karakeep.png"
      homepage.instance.internal.href: "https://keep.${DOMAIN_NAME}"
      wud.watch: "true"
      wud.display.name: "KaraKeep"
      wud.display.icon: "sh:karakeep"
      wud.tag.include: '^\d+\.\d+\.\d+$'
      wud.link.template: "https://github.com/karakeep-app/karakeep/releases/tag/v$${major}.$${minor}.$${patch}"
    hostname: karakeep
    image: ghcr.io/karakeep-app/karakeep:0.29.1
    ipc: private
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: '1G'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/api/health || wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      karakeep-chrome:
        condition: service_healthy
      karakeep-meilisearch:
        condition: service_healthy
    networks:
      - karakeep
      - traefik
    ports:
      - 3000:3000/tcp
    restart: unless-stopped
    volumes:
      - /opt/docker/openwebui/karakeep_data:/data
  karakeep-meilisearch:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - MKNOD
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    container_name: karakeep-meilisearch
    environment:
      MEILI_MASTER_KEY: "${MEILISEARCH_SECRET}"
      MEILI_NO_ANALYTICS: "true"
      TZ: "${TZ}"
    labels:
      wud.watch: "true"
      wud.display.name: "KaraKeep - Meilisearch"
      wud.display.icon: "sh:karakeep"
      wud.tag.include: '^v\d+\.\d+\.\d+$'
      wud.link.template: "https://github.com/meilisearch/meilisearch/releases/tag/v$${major}.$${minor}.$${patch}"
    hostname: karakeep-meilisearch
    image: getmeili/meilisearch:v1.26.0
    ipc: private
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: '1G'
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://127.0.0.1:7700/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - karakeep
    restart: unless-stopped
    volumes:
      - /opt/docker/openwebui/meilisearch_data:/meili_data
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
  karakeep-chrome:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    container_name: karakeep-chrome
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    hostname: karakeep-chrome
    image: gcr.io/zenika-hub/alpine-chrome:124
    ipc: private
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:9222/json/version || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      wud.watch: "true"
      wud.display.name: "KaraKeep - Chrome headless"
      wud.display.icon: "sh:karakeep"
      wud.tag.include: '^\d+$'
      wud.link.template: "https://github.com/jlandure/alpine-chrome/releases/tag/v$${major}.$${minor}.$${patch}"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: '512M'
    networks:
      - karakeep
    restart: unless-stopped
    shm_size: '1gb'
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
networks:
  karakeep:
    name: karakeep
    driver: bridge
    external: false
  traefik:
    external: true