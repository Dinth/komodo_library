services:
  unifi-db:
    image: docker.io/mongo:8.2.5
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    container_name: unifi-db
    labels:
      wud.watch: "true"
      wud.tag.include: '^v?\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/mongodb/mongo/releases/tag/r$${major}.$${minor}.$${patch}'
      wud.display.name: 'Unifi Network Application - Mongo DB'
      wud.display.icon: 'sh:ubiquiti-unifi-dark'
    volumes:
      - /opt/docker/unifi/unifi_db:/data/db
      - /opt/docker/unifi/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD","mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

  unifi-network-application:
    image: lscr.io/linuxserver/unifi-network-application:10.1.85
    container_name: unifi-network-application
    environment:
      PUID: "${DOCKER_PUID}"
      PGID: "${DOCKER_PGID}"
      TZ: "${TZ}"
      MONGO_USER: "unifi"
      MONGO_PASS: "${MONGO_PASS}"
      MONGO_HOST: "unifi-db"
      MONGO_PORT: "27017"
      MONGO_DBNAME: "unifi"
      MEM_LIMIT: "1024" #optional
      MEM_STARTUP: "1024" #optional
    labels:
      homepage.description: "WiFi management"
      homepage.group: "Infrastructure"
      homepage.href: "https://10.10.1.13:8443"
      homepage.icon: "sh-ubiquiti-unifi-dark.png"
      homepage.name: "Unifi Network Application"
      homepage.widget.type: "unifi"
      homepage.widget.url: "https://10.10.1.13:8443"
      homepage.widget.username: "${HOMEPAGE_UNIFI_USER}"
      homepage.widget.password: "${HOMEPAGE_UNIFI_PASS}"
      wud.watch: "true"
      wud.tag.include: '^v?\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/linuxserver/docker-unifi-network-application/releases/tag/$${major}.$${minor}.$${patch}'
      wud.display.name: 'Unifi Network Application'
      wud.display.icon: 'sh:ubiquiti-unifi-dark'
      repliqate.enabled: 'true'
      repliqate.engine: "restic"
      repliqate.schedule: "@weekly 3am" # Trigger every day at 3 am
      repliqate.backup_id: unifi
      repliqate.retention: "90d" # Keep backups for 30 days
    volumes:
      - ./config:/config
    ports:
      - 8443:8443
      - 3478:3478/udp
      - 10001:10001/udp
      - 9080:8080
#     - 1900:1900/udp #optional
      - 8843:8843 #optional
      - 8880:8880 #optional
      - 6789:6789 #optional
      - 5514:5514/udp #optional
    restart: unless-stopped
  unifi-network-mcp:
    image: ghcr.io/sirkirby/unifi-network-mcp:latest
    container_name: unifi-network-mcp
    cap_add: []
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    environment:
      PUID: "${DOCKER_PUID}"
      PGID: "${DOCKER_PGID}"
      TZ: "${TZ}"
      UNIFI_HOST: "10.10.1.13"
      UNIFI_USERNAME: "mcp"
      UNIFI_PASSWORD: "${UNIFI_MCP_PASS}"
      UNIFI_PORT: "8443"
      UNIFI_SITE: "default"
      UNIFI_VERIFY_SSL: "false"
      UNIFI_MCP_HTTP_ENABLED: "true"
      UNIFI_MCP_ALLOWED_HOSTS: "10.10.1.13:5134,localhost:3000"
    labels:
      homepage.description: "UniFi Network MCP (HTTP/SSE)"
      homepage.group: "Infrastructure"
      homepage.icon: "sh-ubiquiti-unifi-dark.png"
      homepage.name: "UniFi Network MCP"
      wud.watch: "true"
      wud.tag.include: '^v?\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/sirkirby/unifi-network-mcp/releases/tag/v$${major}.$${minor}.$${patch}'
      wud.display.name: 'UniFi Network MCP'
      wud.display.icon: 'sh:ubiquiti-unifi-dark'
    ports:
      - "5134:3000"
    restart: unless-stopped
    depends_on:
      - unifi-network-application