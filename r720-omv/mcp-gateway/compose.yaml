x-versions:
  mcp-gateway-socket-proxy-version: &mcp-gateway-socket-proxy-version wollomatic/socket-proxy:1.11.0
  mcp-gateway-version: &mcp-gateway-version docker/mcp-gateway:latest

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  mcp-gateway-socket-proxy:
    image: *mcp-gateway-socket-proxy-version
    container_name: mcp-gateway-socket-proxy
    ipc: private
    restart: unless-stopped
    read_only: true
    mem_limit: 64M
    cap_drop: [ALL]
    security_opt: [no-new-privileges]
    user: "65534:${DOCKER_SOCKET_GID}"
    command:
      - '-loglevel=info'
      - '-allowfrom=mcp-gateway'
      - '-listenip=0.0.0.0'
      - '-allowGET=/v1\..{1,2}/(containers/.*|images/.*|events|info|version)'
      - '-allowHEAD=/_ping'
      - '-allowPOST=/v1\..{1,2}/(containers/.*|images/create)'
      - '-allowhealthcheck'
      - '-watchdoginterval=1200'
      - '-stoponwatchdog'
      - '-shutdowngracetime=10'     
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [mcp-gateway]
    healthcheck:
      test: ["CMD", "./healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 10s
    logging: *default-logging
    labels:
      wud.watch: "true"

  mcp-gateway:
    image: *mcp-gateway-version
    container_name: mcp-gateway
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 512M
    ports: ["4888:8080"]
    command:
      - "--transport=sse"
      - "--port=8080"
      - "--servers=hass-mcp,docker-mcp,containers-data"
    environment:
      TZ: "${TZ}"
      DOCKER_HOST: "tcp://mcp-gateway-socket-proxy:2375"
    volumes:
      - /opt/docker/mcp-gateway/mcp-gateway_config:/app/config:ro
      - /opt/docker/mcp-gateway/mcp-gateway_certs:/certs:ro
      - /opt/docker:/opt/docker:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      mcp-gateway-socket-proxy: { condition: service_healthy }
    networks: [mcp-gateway]
    logging: *default-logging
    labels:
      wud.watch: "true"
networks:
  mcp-gateway:
    name: mcp-gateway
    driver: bridge