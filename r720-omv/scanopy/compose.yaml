x-versions:
  scanopy-daemon-version: &scanopy-daemon-version ghcr.io/scanopy/scanopy/daemon:v0.14.3
  scanopy-server-version: &scanopy-server-version ghcr.io/scanopy/scanopy/server:v0.14.3
  scanopy-postgres-version: &scanopy-postgres-version postgres:18.1-alpine

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-scanopy-env: &scanopy-env
  SCANOPY_LOG_LEVEL: ${SCANOPY_LOG_LEVEL:-info}
  SCANOPY_SERVER_PORT: ${SCANOPY_SERVER_PORT:-60072}
  SCANOPY_DAEMON_PORT: ${SCANOPY_DAEMON_PORT:-60073}

services:
  scanopy-daemon:
    image: *scanopy-daemon-version
    container_name: scanopy-daemon
    network_mode: host
    privileged: true
    ports:
      - 60073:60073
    restart: unless-stopped
    mem_limit: 1G
    environment:
      <<: *scanopy-env
      SCANOPY_SERVER_URL: ${SCANOPY_SERVER_URL:-http://127.0.0.1:60072}
      SCANOPY_PORT: ${SCANOPY_DAEMON_PORT:-60073}
      SCANOPY_BIND_ADDRESS: ${SCANOPY_BIND_ADDRESS:-0.0.0.0}
      SCANOPY_NAME: "r720-omv_daemon"
      SCANOPY_HEARTBEAT_INTERVAL: ${SCANOPY_HEARTBEAT_INTERVAL:-30}
      SCANOPY_MODE: "Push"
      SCANOPY_DAEMON_API_KEY: "${SCANOPY_TOKEN}"
    volumes:
      - /opt/docker/scanopy/scanopy_daemon-config:/root/.config/daemon
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${SCANOPY_DAEMON_PORT:-60073}/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^v\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/scanopy/scanopy/releases/tag/$${major}.$${minor}.$${patch}"
      wud.display.name: "Scanopy Daemon"

  scanopy-postgres:
    image: *scanopy-postgres-version
    container_name: scanopy-postgres
    ipc: private
    restart: unless-stopped
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    cap_add: [CHOWN, DAC_OVERRIDE, SETGID, SETUID, FOWNER]
    mem_limit: 1G
    environment:
      POSTGRES_DB: scanopy
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "${SCANOPY_DB_PASS}"
    volumes:
      - /opt/docker/scanopy/scanopy_postgres:/var/lib/postgresql
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [scanopy]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+-alpine$$'
      wud.link.template: "https://www.postgresql.org/docs/release/$${major}.$${minor}/"
      wud.display.name: "Postgres - Scanopy"
  scanopy-server:
    image: *scanopy-server-version
    container_name: scanopy-server
    ipc: private
    restart: unless-stopped
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    mem_limit: 2G
    ports: 
      - "${SCANOPY_SERVER_PORT:-60072}:${SCANOPY_SERVER_PORT:-60072}"
    environment:
      <<: *scanopy-env
      SCANOPY_DATABASE_URL: "postgresql://postgres:${SCANOPY_DB_PASS}@scanopy-postgres:5432/scanopy"
      SCANOPY_WEB_EXTERNAL_PATH: /app/static
      SCANOPY_PUBLIC_URL: ${SCANOPY_PUBLIC_URL:-http://localhost:${SCANOPY_SERVER_PORT:-60072}}
      SCANOPY_INTEGRATED_DAEMON_URL: http://169.254.0.1:${SCANOPY_DAEMON_PORT:-60073}
    volumes:
      - /opt/docker/scanopy/scanopy_data:/data
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      scanopy-postgres: { condition: service_healthy }
      scanopy-daemon: { condition: service_healthy }
    networks: [scanopy]
    logging: *default-logging
    labels:
      wud.watch: "true"
      wud.tag.include: '^v\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/scanopy/scanopy/releases/tag/$${major}.$${minor}.$${patch}"
      wud.display.name: "Scanopy Server"

networks:
  scanopy:
    name: scanopy
    driver: bridge
