services:
  pricebuddy:
    build:
      context: .
      dockerfile: docker/php.dockerfile
    image: jez500/pricebuddy:latest
    ports:
      - 5757:80
    volumes:
      - /opt/docker/pricebuddy/pricebuddy_data:/app/storage
    environment:
      DB_HOST: "pricebuddy-mariadb"
      DB_USERNAME: "pricebuddy"
      DB_PASSWORD: "${PRICEBUDDY_DB_PASS}"
      DB_DATABASE: "pricebuddy"
      APP_USER_EMAIL: "${ADMIN_EMAIL}"
      APP_USER_PASSWORD: "${PRICEBUDDY_ADMIN_PASS}"
      SCRAPER_BASE_URL: "http://pricebuddy-scraper:3000"
      AFFILIATE_ENABLED: "false"
      ASSET_URL: "https://prices.${DOMAIN_NAME}"
      APP_URL: "https://prices.${DOMAIN_NAME}"
    depends_on:
      - pricebuddy-mariadb
    labels:  
      traefik.enable: "true"
      traefik.http.routers.pricebuddy.rule: "Host(`prices.${DOMAIN_NAME}`)"
      traefik.http.routers.pricebuddy.entrypoints: "websecure"
      traefik.http.routers.pricebuddy.tls: "true"
      traefik.http.routers.pricebuddy.tls.certresolver: "letsencrypt"
      traefik.http.routers.pricebuddy.tls.domains[0].main: "${DOMAIN_NAME}"
      traefik.http.routers.pricebuddy.tls.domains[0].sans: "*.${DOMAIN_NAME}"
      traefik.http.routers.pricebuddy.middlewares: "secHeaders@file"
      traefik.http.services.pricebuddy.loadbalancer.server.port: "80"
      homepage.group: "Home"
      homepage.name: "Pricebuddy"
      homepage.icon: "sh-pricebuddy.png"
      homepage.href: "https://prices.${DOMAIN_NAME}"
      homepage.description: "Price tracker"
      wud.watch: "true"
      wud.tag.include: '^v?\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/jez500/pricebuddy/releases/tag/v$${major}.$${minor}.$${patch}'
      wud.display.name: 'Pricebuddy'
      wud.display.icon: 'sh:pricebuddy'
    networks:
      - pricebuddy
      - traefik

  pricebuddy-mariadb:
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges=true
    container_name: pricebuddy-mariadb
    environment:
      MYSQL_DIR: "/config"
      DATADIR: "/config/databases"
      MYSQL_ROOT_PASSWORD: "${PRICEBUDDY_DB_PASS}"
      MYSQL_DATABASE: "pricebuddy"
      MYSQL_USER: "pricebuddy"
      MYSQL_PASSWORD: "${PRICEBUDDY_DB_PASS}"
      PUID: "${DOCKER_PUID}"
      PGID: "${DOCKER_PGID}"
      TZ: "${TZ}"
    hostname: pricebuddy-mariadb
    image: linuxserver/mariadb:11.4.8
    ipc: private
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g
        reservations:
          memory: 512m
    networks:
      - pricebuddy
      - adminer
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u\"$${MYSQL_USER}\" -p\"$${MYSQL_PASSWORD}\" --protocol=tcp || exit 1"]
      start_period: 60s
      interval: 30s
      timeout: 5s
      retries: 5
    labels:
      wud.display.name: "Pricebuddy - MariaDB"
      wud.display.icon: "sh-pricebuddy"
      wud.watch: "true"
      wud.tag.include: '^v\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/MariaDB/server/releases/tag/mariadb-$${major}.$${minor}.$${patch}'
    volumes:
      - /opt/docker/pricebuddy/mariadb_data:/config

  pricebuddy-scraper:
    image: amerkurev/scrapper:latest
    networks:
      - pricebuddy
#    ports:
#      - 3030:3000
    labels:
      wud.watch: "true"
      wud.tag.include: '^v?\d+\.\d+\.\d+$$'
      wud.link.template: 'https://github.com/amerkurev/scrapper/releases/tag/v$${major}.$${minor}.$${patch}'
      wud.display.name: 'Pricebuddy Scrapper'
      wud.display.icon: 'sh:pricebuddy'

networks:
  pricebuddy:
    name: pricebuddy
    driver: bridge
    external: false
  traefik:
    external: true
  adminer:
    external: true