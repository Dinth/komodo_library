services:
  adventurelog-postgis:
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
      - SETUID
      - SETGID
    cap_drop:
      - ALL
    command: ['postgres']
    container_name: adventurelog-postgis
    entrypoint: ['docker-entrypoint.sh']
    environment:
      POSTGRES_USER: "adventurelog"
      PGUSER: "adventurelog"
      POSTGRES_PASSWORD: "${ADVENTURELOG_DB_PASS}"
    hostname: adventurelog-postgis
    image: postgis/postgis:17-3.5-alpine
    ipc: private
    healthcheck:
      test: [ 'CMD-SHELL','pg_isready','-U','adventurelog','-d','adventurelog' ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      wud.watch: "true"
      wud.tag.include: '^17-\d+\.\d+-alpine$$'
      wud.display.name: "AdventureLog - Postgis"
      wud.display.icon: "sh-dawarich"  
    networks:
      - adventurelog
    restart: unless-stopped
    volumes:
      - /opt/docker/adventurelog/postgis_data:/var/lib/postgresql/data

  adventurelog-web:
    image: ghcr.io/seanmorley15/adventurelog-frontend:v0.11.0
    restart: unless-stopped
    environment:
      PUBLIC_SERVER_URL: "http://server:8000"
      BODY_SIZE_LIMIT: "100000"
    labels:

    depends_on:
      - adventurelog-server

  adventurelog-server:
    image: ghcr.io/seanmorley15/adventurelog-backend:v0.11.0
    restart: unless-stopped
    environment:
      PGHOST: "adventurelog-postgis"
      PGDATABASE: "adventurelog"
      PGUSER: "adventurelog"
      PGPASSWORD: "${ADVENTURELOG_DB_PASS}"
      SECRET_KEY: "${ADVENTURELOG_SECRET_KEY}"
      DJANGO_ADMIN_USERNAME: "admin"
      DJANGO_ADMIN_PASSWORD: "${ADVENTURELOG_ADMIN_PASS}"
      DJANGO_ADMIN_EMAIL: "${ADMIN_EMAIL}"
      PUBLIC_URL: "https://adventure.${DOMAIN_NAME}"
      CSRF_TRUSTED_ORIGINS: "https://adventure.${DOMAIN_NAME}" 
      DEBUG: "false"
      FRONTEND_URL: "https://adventure.${DOMAIN_NAME}"
    volumes:
      - adventurelog-media:/code/media
    labels:

    depends_on:
      adventurelog-postgis:
        condition: service-healthy
networks:
  adventurelog:
    external: false
    name: adventurelog
    driver: bridge
  adminer:
    external: true
  traefik:
    external: true