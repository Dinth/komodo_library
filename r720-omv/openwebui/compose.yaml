x-versions:
  ollama: &ollama-version "ollama/ollama:0.16.1"
  openwebui: &openwebui-version "ghcr.io/open-webui/open-webui:v0.8.0"
  hass-mcp: &hass-mcp-version "voska/hass-mcp:0.1.1"

services:
  ollama:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - KILL
      - MKNOD
      - NET_BIND_SERVICE
      - NET_RAW
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    command: ['serve']
    container_name: ollama
    entrypoint: ['/bin/ollama']
    environment:
      OLLAMA_HOST: "0.0.0.0"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      NVIDIA_VISIBLE_DEVICES: "all"
      OLLAMA_NUM_PARALLEL: "1"
      OLLAMA_MAX_LOADED_MODELS: "1"
      OLLAMA_KEEP_ALIVE: "24h"
      OLLAMA_DEBUG: "1"
      OLLAMA_FLASH_ATTENTION: "1"
      OLLAMA_KV_CACHE_TYPE: "q4_0"
      TZ: "${TZ}"
    hostname: ollama
    image: *ollama-version
    ipc: private
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: '8G'
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute,utility]
    labels:
      wud.watch: "true"
      wud.watch.digest: "true"
      wud.display.name: "Ollama"
      wud.display.icon: "sh:ollama"
      wud.tag.include: '^\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/ollama/ollama/releases/tag/v$${major}.$${minor}.$${patch}"
    healthcheck:
      test: "ollama --version && ollama ps && bash -c 'cat < /dev/null > /dev/tcp/localhost/11434'|| exit 1"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - openwebui
    ports:
      - 11434:11434/tcp
    restart: unless-stopped
    volumes:
      - /opt/docker/openwebui/ollama_data:/root/.ollama
  automatic1111:
    image: universonic/stable-diffusion-webui:latest
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - KILL
      - MKNOD
      - NET_BIND_SERVICE
      - NET_RAW
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    container_name: automatic1111
    environment:
      CLI_ARGS: "--listen --xformers --api"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      NVIDIA_VISIBLE_DEVICES: "all"
      TZ: "${TZ}"
    hostname: automatic1111
    ipc: private
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: '12G'
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute,utility]
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:7860/sdapi/v1/sd-models || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
#    labels:
    networks:
      - openwebui
    ports:
      - 7860:7860/tcp
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    volumes:
      - /opt/docker/openwebui/automatic1111_models:/app/stable-diffusion-webui/models/Stable-diffusion
      - /opt/docker/openwebui/automatic1111_outputs:/app/stable-diffusion-webui/outputs
      - /opt/docker/openwebui/automatic1111_extensions:/app/stable-diffusion-webui/extensions
      - /opt/docker/openwebui/automatic1111_config:/app/stable-diffusion-webui/config
    restart: unless-stopped
  openwebui-pipelines:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - KILL
      - MKNOD
      - NET_BIND_SERVICE
      - NET_RAW
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    container_name: openwebui-pipelines
    environment:
      PIPELINES_PORT: "9099"
      OLLAMA_BASE_URL: "http://ollama:11434"
      DATABASE_URL: "sqlite:///app/pipelines/pipelines.db"  
      PIPELINES_API_KEY: "${OPENWEBUI_PIPELINES_PASS}"
      PIPELINES_URLS: "https://raw.githubusercontent.com/open-webui/pipelines/main/examples/pipelines/providers/google_manifold_pipeline.py"
    hostname: openwebui-pipelines
    image: ghcr.io/open-webui/pipelines:main
    ipc: private
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    tmpfs:
      - /tmp
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: '2G'
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9099/models"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - openwebui
    labels:  
      wud.watch: "true"
      wud.watch.digest: "true"
      wud.display.name: "OpenWebUI Pipelines"
      wud.display.icon: "sh:open-webui"
      wud.tag.include: '^v\d+\.\d+\.\d+$'
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    volumes:
      - /opt/docker/openwebui/openwebui-pipelines_data:/app/pipelines
  openwebui:
    cap_add:
      - AUDIT_WRITE
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - KILL
      - MKNOD
      - NET_BIND_SERVICE
      - NET_RAW
      - SETFCAP
      - SETGID
      - SETPCAP
      - SETUID
      - SYS_CHROOT
    cap_drop:
      - ALL
    container_name: openwebui
    environment:
      USE_OLLAMA_DOCKER: "true"
      PORT: "8080"
      OLLAMA_BASE_URL: "http://ollama:11434"
      PIPELINES_URL: "http://openwebui-pipelines:9099"
      ENABLE_SIGNUP: "false"
      WEBUI_AUTH: "true"
      WEBUI_SECRET_KEY: "${OPENWEBUI_SECRET_KEY}"
      SCARF_NO_ANALYTICS: "true"
      DO_NOT_TRACK: "true"
      ANONYMIZED_TELEMETRY: "true"
      ENABLE_RAG_WEB_SEARCH: "true"
      RAG_WEB_SEARCH_ENGINE: "searxng"
      RAG_WEB_SEARCH_RESULT_COUNT: 3
      RAG_WEB_SEARCH_CONCURRENT_REQUESTS: 10
      SEARXNG_QUERY_URL: "https://search.${DOMAIN_NAME}/search?q=<query>"
      ENABLE_IMAGE_GENERATION: "true"
      IMAGE_GENERATION_ENGINE: "automatic1111"
      AUTOMATIC1111_BASE_URL: "http://automatic1111:7860"
      MCP_SERVERS: "Grafana@http://mcp-grafana:5133"
      OPENWEBUI_MCP_SYNC_MODE: "true"
    hostname: openwebui
    image: *openwebui-version
    ipc: private
    healthcheck: 
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      ollama:
        condition: service_healthy
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    tmpfs:
      - /tmp
    networks:
      - openwebui
      - traefik
    ports:
      - 3311:8080/tcp
    labels:
      traefik.enable: "true"
      traefik.http.routers.openwebai.rule: "Host(`ai.${DOMAIN_NAME}`)"
      traefik.http.routers.openwebai.entrypoints: "websecure"
      traefik.http.routers.openwebai.tls: "true"
      traefik.http.routers.openwebai.tls.certresolver: "letsencrypt"
      traefik.http.routers.openwebai.tls.domains[0].main: "${DOMAIN_NAME}"
      traefik.http.routers.openwebai.tls.domains[0].sans: "*.${DOMAIN_NAME}"
      traefik.http.routers.openwebai.middlewares: "secHeaders@file"
      traefik.http.services.openwebai.loadbalancer.server.port: "8080"
      homepage.group: "Home"
      homepage.name: "OpenWebUI"
      homepage.icon: "sh-open-webui.png"
      homepage.instance.internal.href: "https://ai.${DOMAIN_NAME}"
      homepage.siteMonitor: "https://ai.${DOMAIN_NAME}"
      wud.watch: "true"
      wud.display.name: "OpenWebUI Server - AI agent manager"
      wud.display.icon: "sh:open-webui"
      wud.tag.include: '^v\d+\.\d+\.\d+$'
      wud.link.template: "https://github.com/open-webui/open-webui/releases/tag/v$${major}.$${minor}.$${patch}"
    restart: unless-stopped
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    volumes:
      - /opt/docker/openwebui/openwebui_data:/app/backend/data
  mcp-hass:
    cap_drop:
      - ALL
    container_name: mcp-hass
    environment:
      HA_URL: "http://10.10.1.11:8123"
      HA_TOKEN: "${HASS_TOKEN}"
      TZ: "${TZ}"
    hostname: mcp-hass
    image: *hass-mcp-version
    ipc: private
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    stdin_open: true
    tty: false
    tmpfs:
      - /tmp
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: '512M'
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f python || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - openwebui
    labels:
      wud.watch: "true"
      wud.watch.digest: "true"
      wud.display.name: "Home Assistant MCP"
      wud.display.icon: "sh:home-assistant"
      wud.tag.include: '^\d+\.\d+\.\d+$$'
      wud.link.template: "https://github.com/voska/hass-mcp/releases/tag/v$${major}.$${minor}.$${patch}"
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    volumes:
      - /opt/docker/openwebui/mcp-hass_data:/app/data
networks:
  openwebui:
    name: openwebui
    driver: bridge
    external: false
  traefik:
    external: true