x-versions:
  influxdb: &influxdb-version "influxdb:2.8.0-alpine"
  telegraf-version: &telegraf-version "telegraf:1.37-alpine"
  unpoller-version: &unpoller-version "ghcr.io/unpoller/unpoller:v2.21.0"

services:
  influxdb:
    container_name: influxdb
    image: *influxdb-version
    restart: unless-stopped
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cap_drop:
      - ALL
    environment:
      DOCKER_INFLUXDB_INIT_MODE: "setup"
      DOCKER_INFLUXDB_INIT_USERNAME: "admin"
      DOCKER_INFLUXDB_INIT_PASSWORD: "${INFLUXDB_PASSWORD}"
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: "${INFLUXDB_TOKEN}"
      DOCKER_INFLUXDB_INIT_ORG: "wickhay"
      DOCKER_INFLUXDB_INIT_BUCKET: "home_assistant"
      DOCKER_INFLUXDB_INIT_RETENTION: "30d"
      INFLUXDB_HTTP_AUTH_ENABLED: "true"
      TZ: "${TZ}"
    hostname: influxdb
    ipc: private
    networks:
      - monitoring
    ports:
      - "8086:8086/tcp"
    volumes:
      - /opt/docker/influxdb-telegraf/influxdb_storage:/var/lib/influxdb2
      - /opt/docker/influxdb-telegraf/influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD-SHELL", "influx ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+\.\d+-alpine$$'
      wud.display.name: "InfluxDB"
      wud.display.icon: "si:influxdb"
      wud.link.template: 'https://github.com/influxdata/influxdb/releases/tag/v$${major}.$${minor}.$${patch}'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  telegraf:
    container_name: telegraf
    image: *telegraf-version
    restart: unless-stopped
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
      - NET_RAW  # Needed for SNMP/ICMP
    cap_drop:
      - ALL
    environment:
      INFLUX_TOKEN: "${INFLUXDB_TOKEN}"
      TZ: "${TZ}"
    hostname: telegraf
    ipc: private
    networks:
      - monitoring
    ports: []
    volumes:
      - /opt/docker/influxdb-telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    depends_on:
      influxdb:
        condition: service_healthy
        restart: true
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      wud.watch: "true"
      wud.tag.include: '^\d+\.\d+-alpine$$'
      wud.display.name: "Telegraf"
      wud.display.icon: "si:influxdb"
      wud.link.template: 'https://github.com/influxdata/telegraf/releases/tag/v$${major}.$${minor}.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  unpoller:
    container_name: unpoller
    image: *unpoller-version
    restart: unless-stopped
    user: "${DOCKER_PUID}:${DOCKER_PGID}"
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cap_drop:
      - ALL
    environment:
      TZ: "${TZ}"
      # UniFi Controller configuration
      UP_UNIFI_CONTROLLER_0_URL: "https://10.10.1.13:8443"
      UP_UNIFI_CONTROLLER_0_USER: "telegraf_monitor"
      UP_UNIFI_CONTROLLER_0_PASS: "${UNPOLLER_UNIFI_PASS}"
      UP_UNIFI_CONTROLLER_0_VERIFY_SSL: "false"
      UP_UNIFI_CONTROLLER_0_SAVE_SITES: "true"
      UP_UNIFI_CONTROLLER_0_SAVE_DPI: "false"
      UP_UNIFI_CONTROLLER_0_SAVE_IDS: "false"
      UP_UNIFI_CONTROLLER_0_SAVE_EVENTS: "false"
      UP_UNIFI_CONTROLLER_0_SAVE_ANOMALIES: "false"
      UP_UNIFI_CONTROLLER_0_SAVE_ALARMS: "false"
      # InfluxDB configuration
      UP_INFLUXDB_URL: "http://influxdb:8086"
      UP_INFLUXDB_ORG: "wickhay"
      UP_INFLUXDB_BUCKET: "network"
      UP_INFLUXDB_TOKEN: "${INFLUXDB_TOKEN}"
      # Poller configuration
      UP_POLLER_DEBUG: "false"
      UP_POLLER_QUIET: "false"
    hostname: unpoller
    ipc: private
    networks:
      - monitoring
    ports: []
    volumes:
      - /opt/docker/influxdb-telegraf/unpoller_config:/config:ro
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:9130/metrics || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      wud.watch: "true"
      wud.display.name: "UnPoller"
      wud.display.icon: "si:ubiquiti"
      wud.link.template: 'https://github.com/unpoller/unpoller/releases/tag/$${version}'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  monitoring:
    name: monitoring
    driver: bridge
    external: true
